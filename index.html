<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (Job Distributor By SHU)</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; color: #334155; }
        
        /* Card Effects */
        .card { transition: all 0.3s ease; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Animations */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .list-move, .list-enter-active, .list-leave-active { transition: all 0.4s ease; }
        .list-enter-from, .list-leave-to { opacity: 0; transform: translateX(-20px); }
        .list-leave-active { position: absolute; }
        
        .animate-fade-in-up { animation: fadeInUp 0.5s ease-out; }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Tool Button Style */
        .btn-tool {
            @apply px-3 py-1.5 rounded-lg text-xs font-semibold transition flex items-center gap-1 shadow-sm transform active:scale-95;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div id="app" class="max-w-7xl mx-auto">
        
        <div class="text-center mb-8 relative">
            <h1 class="text-3xl md:text-4xl font-bold text-indigo-700 mb-2 drop-shadow-sm flex justify-center items-center gap-3">
                <i class="fa-solid fa-scale-balanced text-indigo-500"></i>
                ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏à‡∏±‡∏î‡∏ö‡∏¥‡∏•
            </h1>
            <p class="text-gray-500 text-lg">Created By Shu</p>
            
            <transition name="fade">
                <div v-if="toast.show" 
                     class="fixed top-5 right-5 z-50 px-4 py-3 rounded-lg shadow-xl text-white font-medium flex items-center gap-3 max-w-sm"
                     :class="toast.type === 'error' ? 'bg-red-500' : 'bg-emerald-600'">
                    <i :class="toast.type === 'error' ? 'fa-solid fa-circle-exclamation text-xl' : 'fa-solid fa-circle-check text-xl'"></i>
                    <div>
                        <div class="font-bold text-sm opacity-90">{{ toast.type === 'error' ? '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î' : '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' }}</div>
                        <div class="text-sm">{{ toast.message }}</div>
                    </div>
                </div>
            </transition>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <div class="lg:col-span-5 space-y-6">
                
                <div class="bg-white p-5 rounded-xl shadow-sm border border-indigo-100 card relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1.5 h-full bg-indigo-500"></div>
                    <div class="flex justify-between items-center mb-4 pl-3">
                        <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                            <i class="fa-solid fa-users text-indigo-500"></i> ‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô ({{ employees.length }})
                        </h2>
                        <div class="space-x-2">
                            <button @click="resetEmployees" class="text-xs text-gray-400 hover:text-red-500 underline transition">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
                            <button @click="addEmployee" class="bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-lg hover:bg-indigo-100 text-sm font-semibold transition shadow-sm border border-indigo-100">
                                <i class="fa-solid fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ô
                            </button>
                        </div>
                    </div>

                    <div class="flex text-xs text-gray-400 mb-2 px-2 font-medium uppercase tracking-wide">
                        <div class="w-8 text-center">#</div>
                        <div class="flex-1">‡∏ä‡∏∑‡πà‡∏≠</div>
                        <div class="w-24 text-center cursor-help" title="‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô (100% = ‡∏õ‡∏Å‡∏ï‡∏¥)">Capacity %</div>
                        <div class="w-6"></div>
                    </div>

                    <div class="space-y-2 max-h-[300px] overflow-y-auto pr-1 custom-scrollbar relative">
                        <transition-group name="list">
                            <div v-for="(emp, index) in employees" :key="emp.id || index" class="flex items-center gap-2 group bg-gray-50/50 p-1.5 rounded border border-transparent hover:border-indigo-200 hover:bg-white transition duration-200">
                                <span class="text-gray-400 w-8 text-center text-sm font-mono">{{ index + 1 }}</span>
                                <input type="text" v-model="emp.name" 
                                    class="flex-1 bg-transparent border-b border-gray-200 focus:border-indigo-500 focus:outline-none text-sm py-1 transition text-gray-700 font-medium placeholder-gray-300" 
                                    placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô">
                                
                                <div class="w-24 flex items-center justify-center relative">
                                    <input type="number" v-model.number="emp.capacity" min="10" max="300" step="10"
                                        class="w-16 text-center bg-white border border-gray-200 rounded text-xs py-1 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-200 outline-none transition"
                                        :class="getCapacityColor(emp.capacity)">
                                    <span class="absolute right-2 text-[10px] text-gray-400 pointer-events-none">%</span>
                                </div>

                                <button @click="removeEmployee(index)" class="text-gray-300 hover:text-red-500 w-6 h-6 flex items-center justify-center transition rounded-full hover:bg-red-50">
                                    <i class="fa-solid fa-xmark text-xs"></i>
                                </button>
                            </div>
                        </transition-group>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-sm border border-orange-100 card relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1.5 h-full bg-orange-500"></div>
                    <div class="flex justify-between items-center mb-4 pl-3">
                        <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                            <i class="fa-solid fa-boxes-stacked text-orange-500"></i> ‡∏ä‡∏∏‡∏î‡∏á‡∏≤‡∏ô ({{ taskSets.length }})
                        </h2>
                        <div class="space-x-2">
                            <button @click="resetTaskSets" class="text-xs text-gray-400 hover:text-red-500 underline transition">‡∏•‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô</button>
                            <button @click="addTaskSet" class="bg-orange-50 text-orange-600 px-3 py-1.5 rounded-lg hover:bg-orange-100 text-sm font-semibold transition shadow-sm border border-orange-100">
                                <i class="fa-solid fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∏‡∏î
                            </button>
                        </div>
                    </div>
                    
                    <div class="space-y-4 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar">
                        <transition-group name="list">
                            <div v-for="(set, setIndex) in taskSets" :key="set.id" 
                                 class="border rounded-lg p-4 bg-white relative transition-all duration-300 group hover:shadow-md"
                                 :class="setIndex === 0 ? 'border-l-4 border-l-red-400 border-y-gray-200 border-r-gray-200' : 'border-gray-200 hover:border-orange-300'">
                                
                                <div class="flex justify-between items-center mb-2">
                                    <span class="font-bold text-gray-700 text-sm flex items-center gap-2">
                                        <span class="w-3 h-3 rounded-full shadow-sm ring-2 ring-white" :class="getDotColor(setIndex)"></span>
                                        ‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà {{ setIndex + 1 }} 
                                        <span v-if="setIndex === 0" class="text-[10px] bg-red-100 text-red-600 px-2 py-0.5 rounded-full uppercase font-bold tracking-wider border border-red-200">Priority</span>
                                    </span>
                                    <button @click="removeTaskSet(setIndex)" class="text-gray-300 hover:text-red-600 text-xs transition px-2 py-1 rounded hover:bg-red-50">
                                        <i class="fa-regular fa-trash-can"></i> ‡∏•‡∏ö
                                    </button>
                                </div>
                                
                                <div class="mb-2">
                                    <textarea v-model="set.rawInput" 
                                        class="w-full h-20 border border-gray-300 rounded-lg p-2 text-sm focus:outline-none focus:border-orange-500 focus:ring-2 focus:ring-orange-100 font-mono resize-none transition bg-gray-50 focus:bg-white placeholder-gray-400" 
                                        placeholder="‡∏ß‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏á‡∏≤‡∏ô ‡πÄ‡∏ä‡πà‡∏ô: 55 20 14..."></textarea>
                                </div>
                                <div class="flex justify-between text-xs text-gray-500 bg-white border border-gray-100 p-1.5 rounded shadow-sm">
                                    <span class="font-medium"><i class="fa-solid fa-list-ol mr-1 text-gray-400"></i> {{ countNumbers(set.rawInput) }} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                                    <span class="font-mono text-indigo-600">Total: {{ sumNumbers(set.rawInput).toLocaleString() }}</span>
                                </div>
                            </div>
                        </transition-group>
                    </div>
                </div>

                <button @click="calculateDistribution" 
                    class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-indigo-200 transition transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center gap-3 text-lg group overflow-hidden relative">
                    <div class="absolute inset-0 bg-white/10 transform -skew-x-12 -translate-x-full group-hover:translate-x-full transition-transform duration-700"></div>
                    <i class="fa-solid fa-rocket group-hover:animate-bounce"></i> 
                    <span>‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</span>
                </button>

            </div>

            <div class="lg:col-span-7">
                
                <div v-if="distributedResults.length > 0" class="animate-fade-in-up">
                    
                    <div class="flex flex-wrap gap-2 mb-4 justify-end bg-white p-2 rounded-lg shadow-sm border border-gray-100">
                        <div class="flex items-center mr-auto pl-3 text-sm text-gray-500 font-medium">
                           <i class="fa-solid fa-chart-pie mr-2 text-indigo-500"></i> ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                        </div>
                        <button @click="exportToExcel" class="btn-tool bg-green-50 text-green-700 hover:bg-green-100 border border-green-200">
                            <i class="fa-regular fa-file-excel text-lg"></i> Excel
                        </button>
                        <button @click="exportToImage" class="btn-tool bg-purple-50 text-purple-700 hover:bg-purple-100 border border-purple-200">
                            <i class="fa-regular fa-image text-lg"></i> Image
                        </button>
                        <button @click="exportToPDF" class="btn-tool bg-red-50 text-red-700 hover:bg-red-100 border border-red-200">
                            <i class="fa-regular fa-file-pdf text-lg"></i> PDF
                        </button>
                        <button @click="copyText" class="btn-tool bg-gray-50 text-gray-700 hover:bg-gray-100 border border-gray-200">
                            <i class="fa-regular fa-copy text-lg"></i> Copy
                        </button>
                    </div>

                    <div id="export-area" class="bg-white p-6 md:p-8 rounded-xl shadow-lg border border-gray-100 min-h-[600px] relative">
                        
                        <div class="absolute top-4 right-4 text-gray-100 text-6xl font-bold opacity-30 select-none pointer-events-none">
                            ULTIMATE
                        </div>

                        <div class="text-center mb-8 border-b border-gray-200 pb-6">
                            <h2 class="text-2xl font-bold text-gray-800">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h2>
                            <p class="text-gray-400 text-xs mt-1">
                                <i class="fa-regular fa-clock"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà {{ new Date().toLocaleString('th-TH') }}
                            </p>
                            
                            <div class="grid grid-cols-3 gap-4 mt-6 max-w-2xl mx-auto">
                                <div class="bg-blue-50 p-3 rounded-lg text-center border border-blue-100 card">
                                    <div class="text-[10px] text-blue-500 font-bold uppercase tracking-wide mb-1">‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                                    <div class="text-xl font-bold text-blue-700">{{ grandTotalItems }} <span class="text-sm font-normal text-blue-400">‡∏ä‡∏¥‡πâ‡∏ô</span></div>
                                </div>
                                <div class="bg-green-50 p-3 rounded-lg text-center border border-green-100 card">
                                    <div class="text-[10px] text-green-500 font-bold uppercase tracking-wide mb-1">Weight ‡∏£‡∏ß‡∏°</div>
                                    <div class="text-xl font-bold text-green-700">{{ grandTotalWeight.toLocaleString() }}</div>
                                </div>
                                <div class="bg-indigo-50 p-3 rounded-lg text-center border border-indigo-100 card">
                                    <div class="text-[10px] text-indigo-500 font-bold uppercase tracking-wide mb-1">Base Avg / Cap</div>
                                    <div class="text-xl font-bold text-indigo-700">~{{ (grandTotalWeight / totalCapacityPoints * 100).toFixed(1) }}</div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div v-for="(result, idx) in distributedResults" :key="idx" 
                                 class="border rounded-lg overflow-hidden flex flex-col h-full bg-white shadow-sm hover:shadow-md transition group border-gray-200">
                                
                                <div class="p-3 border-b bg-gray-50 flex justify-between items-start relative overflow-hidden">
                                    <div class="absolute bottom-0 left-0 h-1 bg-gradient-to-r from-indigo-500 to-purple-500 transition-all duration-1000" 
                                         :style="{ width: Math.min(getLoadPercentage(result.totalWeight, result.capacity), 100) + '%' }"></div>

                                    <div class="flex items-center gap-3 z-10 w-full">
                                        <div class="bg-white border border-gray-200 text-gray-600 w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold shadow-sm flex-shrink-0">
                                            {{ idx + 1 }}
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="flex justify-between items-center">
                                                <h3 class="font-bold text-gray-800 leading-tight truncate pr-2">{{ result.employeeName }}</h3>
                                                <div class="font-bold text-lg text-indigo-700 leading-none whitespace-nowrap">{{ result.totalWeight.toLocaleString() }}</div>
                                            </div>
                                            
                                            <div class="flex justify-between items-center mt-1">
                                                <div class="text-[10px] text-gray-500 flex gap-2 items-center">
                                                    <span class="bg-gray-200 px-1.5 rounded text-gray-600" title="Capacity"><i class="fa-solid fa-gauge-high mr-1"></i>{{ result.capacity }}%</span>
                                                </div>
                                                <div v-if="result.tasks.length > 0" 
                                                     class="text-[10px] font-bold px-1.5 py-0.5 rounded-full bg-white border shadow-sm"
                                                     :class="getLoadColorClass(getLoadPercentage(result.totalWeight, result.capacity))">
                                                    Load: {{ getLoadPercentage(result.totalWeight, result.capacity) }}%
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="p-3 bg-white flex-1 min-h-[100px]">
                                    <div v-if="result.tasks.length === 0" class="h-full flex flex-col items-center justify-center text-gray-300 text-sm py-4">
                                        <i class="fa-solid fa-mug-hot text-2xl mb-2 opacity-50"></i>
                                        <span>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢</span>
                                    </div>
                                    <div v-else class="flex flex-wrap gap-1.5 content-start">
                                        <div v-for="(task, tIndex) in result.tasks" :key="tIndex" 
                                             class="px-2 py-1 rounded text-xs border flex items-center gap-1 shadow-sm hover:scale-105 transition cursor-default bg-white select-all"
                                             :class="getBadgeColor(task.originalSetIndex)">
                                            <span class="font-bold font-mono">{{ task.value }}</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-gray-50 px-3 py-2 text-[10px] text-gray-400 border-t flex justify-between items-center">
                                    <span><i class="fa-solid fa-cubes mr-1"></i>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô {{ result.tasks.length }} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-else class="h-full flex flex-col items-center justify-center text-gray-400 border-2 border-dashed border-gray-300 rounded-xl bg-gray-50/50 min-h-[500px] animate-pulse">
                    <div class="w-24 h-24 bg-white rounded-full flex items-center justify-center mb-6 text-5xl shadow-sm border border-gray-100">
                        <i class="fa-solid fa-calculator text-indigo-200"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-500 mb-2">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏á‡∏≤‡∏ô</h3>
                    <p class="text-sm max-w-xs text-center text-gray-400">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ä‡∏∏‡∏î‡∏á‡∏≤‡∏ô‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡∏°‡∏∑‡∏≠<br>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
                </div>

            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    // Initialize with 3 people, Capacity 100% default
                    employees: [
                        { name: '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô 1', capacity: 100, id: 1 },
                        { name: '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô 2', capacity: 100, id: 2 },
                        { name: '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô 3', capacity: 100, id: 3 }
                    ],
                    taskSets: [
                        { id: 1, rawInput: "55 20 14 16 12 8 90", tasks: [] }
                    ],
                    distributedResults: [],
                    
                    // UX/UI States
                    toast: { show: false, message: '', type: 'success' },
                    
                    // Design System
                    colors: [
                        { bg: 'bg-red-50', text: 'text-red-700', border: 'border-red-200', dot: 'bg-red-500' },
                        { bg: 'bg-orange-50', text: 'text-orange-700', border: 'border-orange-200', dot: 'bg-orange-500' },
                        { bg: 'bg-blue-50', text: 'text-blue-700', border: 'border-blue-200', dot: 'bg-blue-500' },
                        { bg: 'bg-emerald-50', text: 'text-emerald-700', border: 'border-emerald-200', dot: 'bg-emerald-500' },
                        { bg: 'bg-purple-50', text: 'text-purple-700', border: 'border-purple-200', dot: 'bg-purple-500' },
                        { bg: 'bg-pink-50', text: 'text-pink-700', border: 'border-pink-200', dot: 'bg-pink-500' },
                        { bg: 'bg-cyan-50', text: 'text-cyan-700', border: 'border-cyan-200', dot: 'bg-cyan-500' },
                        { bg: 'bg-yellow-50', text: 'text-yellow-700', border: 'border-yellow-200', dot: 'bg-yellow-500' },
                    ]
                }
            },
            mounted() {
                this.loadFromStorage();
            },
            watch: {
                employees: {
                    handler() { this.saveToStorage(); },
                    deep: true
                },
                taskSets: {
                    handler() { this.saveToStorage(); },
                    deep: true
                }
            },
            computed: {
                grandTotalWeight() {
                    return this.distributedResults.reduce((sum, res) => sum + res.totalWeight, 0);
                },
                grandTotalItems() {
                    return this.distributedResults.reduce((sum, res) => sum + res.tasks.length, 0);
                },
                totalCapacityPoints() {
                    // Sum of all capacities to calculate weighted average
                    return this.distributedResults.reduce((sum, res) => sum + res.capacity, 0);
                }
            },
            methods: {
                // --- Storage System ---
                saveToStorage() {
                    localStorage.setItem('jd_employees_v2', JSON.stringify(this.employees));
                    localStorage.setItem('jd_taskSets_v2', JSON.stringify(this.taskSets));
                },
                loadFromStorage() {
                    const emp = localStorage.getItem('jd_employees_v2');
                    const tsk = localStorage.getItem('jd_taskSets_v2');
                    if (emp) this.employees = JSON.parse(emp);
                    if (tsk) this.taskSets = JSON.parse(tsk);
                },

                // --- Helper Logic ---
                parseInput(raw) {
                    if (!raw) return [];
                    const numbers = raw.match(/-?\d+(\.\d+)?/g);
                    return numbers ? numbers.map(n => parseFloat(n)) : [];
                },
                countNumbers(raw) {
                    if (!raw) return 0;
                    return (raw.match(/-?\d+(\.\d+)?/g) || []).length;
                },
                sumNumbers(raw) {
                    const nums = this.parseInput(raw);
                    const sum = nums.reduce((a, b) => a + b, 0);
                    // Format to avoid long decimals
                    return parseFloat(sum.toFixed(2));
                },
                showToast(msg, type = 'success') {
                    this.toast = { show: true, message: msg, type };
                    setTimeout(() => this.toast.show = false, 3000);
                },

                // --- Management ---
                addEmployee() {
                    this.employees.push({ 
                        name: `‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ${this.employees.length + 1}`, 
                        capacity: 100,
                        id: Date.now() 
                    });
                },
                removeEmployee(index) {
                    if (this.employees.length <= 1) return this.showToast('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏ô', 'error');
                    this.employees.splice(index, 1);
                },
                resetEmployees() {
                    if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) {
                        this.employees = [{ name: '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô 1', capacity: 100, id: Date.now() }];
                        this.showToast('‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                    }
                },
                addTaskSet() {
                    this.taskSets.push({ id: Date.now(), rawInput: "", tasks: [] });
                },
                removeTaskSet(index) {
                    this.taskSets.splice(index, 1);
                },
                resetTaskSets() {
                    if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏ä‡∏∏‡∏î‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) {
                        this.taskSets = [{ id: Date.now(), rawInput: "", tasks: [] }];
                        this.showToast('‡∏•‡πâ‡∏≤‡∏á‡∏ä‡∏∏‡∏î‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                    }
                },

                // --- Styles ---
                getStyle(index) { return this.colors[index % this.colors.length]; },
                getBadgeColor(index) {
                    const s = this.getStyle(index);
                    return `${s.bg} ${s.text} ${s.border}`;
                },
                getDotColor(index) { return this.getStyle(index).dot; },
                
                getCapacityColor(cap) {
                    if (cap > 100) return 'text-green-600 font-bold border-green-200 bg-green-50';
                    if (cap < 100) return 'text-orange-500 border-orange-200 bg-orange-50';
                    return 'text-gray-600 border-gray-200';
                },

                getLoadPercentage(currentWeight, capacity) {
                    // Logic: Calculate Relative Load
                    // 100% means this person is carrying exactly their fair share based on their capacity
                    
                    if (this.grandTotalWeight === 0 || this.totalCapacityPoints === 0) return 0;
                    
                    // Share per 1 capacity point
                    const globalSharePerPoint = this.grandTotalWeight / this.totalCapacityPoints;
                    
                    // What this person *should* carry
                    const expectedLoad = globalSharePerPoint * capacity;
                    
                    if (expectedLoad === 0) return 0;
                    
                    // How much they are actually carrying vs expected
                    // Example: Expected 100, Carry 100 => 100%
                    // Expected 100, Carry 120 => 120% (Overloaded)
                    return Math.round((currentWeight / expectedLoad) * 100);
                },
                
                getLoadColorClass(percent) {
                    if (percent > 110) return 'text-red-600 bg-red-50 border-red-100';
                    if (percent < 90) return 'text-blue-500 bg-blue-50 border-blue-100';
                    return 'text-green-600 bg-green-50 border-green-100';
                },

                // --- CORE ALGORITHM (Weighted + Capacity) ---
                calculateDistribution() {
                    const activeEmployees = this.employees.filter(e => e.name.trim() !== "");
                    
                    if (activeEmployees.length === 0) {
                        return this.showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏ô", 'error');
                    }

                    // 1. Prepare Buckets with Capacity
                    let buckets = activeEmployees.map(e => ({
                        employeeName: e.name,
                        capacity: e.capacity || 100, 
                        tasks: [],
                        totalWeight: 0
                    }));

                    let hasWork = false;

                    // 2. Flatten and Process All Tasks (Greedy LPT Strategy)
                    this.taskSets.forEach((set, setIndex) => {
                        const tasks = this.parseInput(set.rawInput);
                        if (tasks.length > 0) hasWork = true;
                        
                        // Sort Descending (Biggest tasks first)
                        tasks.sort((a, b) => b - a);

                        tasks.forEach(taskValue => {
                            // Find bucket with lowest "Relative Load"
                            // Relative Load = CurrentWeight / Capacity
                            // By minimizing this, we ensure a 200% capacity person gets ~2x the work of a 100% person
                            
                            let bestBucketIndex = 0;
                            // Initialize minLoadRatio with the first bucket
                            let minLoadRatio = buckets[0].totalWeight / buckets[0].capacity;

                            for (let i = 1; i < buckets.length; i++) {
                                const ratio = buckets[i].totalWeight / buckets[i].capacity;
                                if (ratio < minLoadRatio) {
                                    minLoadRatio = ratio;
                                    bestBucketIndex = i;
                                }
                            }

                            // Assign task
                            buckets[bestBucketIndex].tasks.push({
                                value: taskValue,
                                originalSetIndex: setIndex
                            });
                            buckets[bestBucketIndex].totalWeight += taskValue;
                        });
                    });

                    if (!hasWork) return this.showToast("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏ô‡∏ä‡∏∏‡∏î‡∏á‡∏≤‡∏ô", 'error');

                    // 3. Post-process (Sort tasks inside buckets for nice display)
                    buckets.forEach(bucket => {
                        // Fix javascript floating point issues
                        bucket.totalWeight = parseFloat(bucket.totalWeight.toFixed(2));
                        
                        // Sort tasks: Group by Set ID, then by Value
                        bucket.tasks.sort((a, b) => {
                            if (a.originalSetIndex !== b.originalSetIndex) return a.originalSetIndex - b.originalSetIndex;
                            return b.value - a.value;
                        });
                    });

                    this.distributedResults = buckets;
                    this.showToast(`‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡πÅ‡∏ö‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ ${activeEmployees.length} ‡∏Ñ‡∏ô`);
                    
                    // Scroll to results
                    setTimeout(() => {
                        const el = document.getElementById('export-area');
                        if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);
                },

                // --- Exports ---
                copyText() {
                    let text = `‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡πà‡∏á‡∏á‡∏≤‡∏ô (${new Date().toLocaleDateString()})\n`;
                    text += `--------------------------------\n`;
                    this.distributedResults.forEach(res => {
                        text += `üë§ ${res.employeeName} (Cap: ${res.capacity}%)\n`;
                        text += `   ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏°: ${res.totalWeight}\n`;
                        text += `   ‡∏á‡∏≤‡∏ô: ${res.tasks.map(t => t.value).join(", ")}\n\n`;
                    });
                    navigator.clipboard.writeText(text).then(() => this.showToast("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏á Clipboard ‡πÅ‡∏•‡πâ‡∏ß"));
                },
                exportToExcel() {
                    let data = [];
                    let maxTasks = 0;
                    this.distributedResults.forEach(res => {
                        if (res.tasks.length > maxTasks) maxTasks = res.tasks.length;
                        let row = {
                            "‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô": res.employeeName,
                            "Capacity(%)": res.capacity,
                            "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏°": res.totalWeight,
                            "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏¥‡πâ‡∏ô": res.tasks.length
                        };
                        res.tasks.forEach((t, i) => {
                            row[`‡∏á‡∏≤‡∏ô_${i+1}`] = t.value;
                            row[`‡∏ä‡∏∏‡∏î_${i+1}`] = t.originalSetIndex + 1;
                        });
                        data.push(row);
                    });
                    const ws = XLSX.utils.json_to_sheet(data);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Work_Distribution");
                    XLSX.writeFile(wb, `Distribution_${new Date().toISOString().slice(0,10)}.xlsx`);
                    this.showToast("‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Excel ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                },
                exportToImage() {
                    const element = document.getElementById('export-area');
                    this.showToast("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û...");
                    html2canvas(element, { scale: 2, backgroundColor: "#ffffff" }).then(canvas => {
                        const link = document.createElement('a');
                        link.download = `Summary_${Date.now()}.png`;
                        link.href = canvas.toDataURL();
                        link.click();
                        this.showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                    });
                },
                exportToPDF() {
                    const element = document.getElementById('export-area');
                    this.showToast("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á PDF...");
                    const opt = {
                        margin: 0.2,
                        filename: `Distribution_${Date.now()}.pdf`,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2, useCORS: true, backgroundColor: "#ffffff" },
                        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
                    };
                    html2pdf().set(opt).from(element).save().then(() => {
                        this.showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å PDF ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                    });
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
