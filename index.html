<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏á‡∏≤‡∏ô Pro Max (Auto-Save + Lock)</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f2f5; }
        .card { transition: all 0.3s ease; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .btn-press:active { transform: scale(0.95); }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body class="p-4 md:p-6 text-slate-800">

    <div id="app" class="max-w-[1400px] mx-auto">
        
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4 bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <div>
                <h1 class="text-3xl font-bold text-indigo-700 flex items-center gap-3">
                    <i class="fa-solid fa-scale-balanced"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏á‡∏≤‡∏ô <span class="text-orange-500 text-lg bg-orange-100 px-2 py-1 rounded-lg">Pro Max</span>
                </h1>
                <p class="text-slate-500 text-sm mt-1">Weighted Load Balancing + History Tracking + Auto Save</p>
            </div>
            <div class="flex gap-3">
                <button @click="resetAllData" class="px-4 py-2 border border-red-200 text-red-600 rounded-lg hover:bg-red-50 text-sm font-bold transition btn-press">
                    <i class="fa-solid fa-trash-can mr-1"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏´‡∏°‡∏î
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <div class="lg:col-span-4 space-y-6">
                
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 card">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-bold text-slate-700 flex items-center gap-2">
                            <span class="bg-indigo-100 text-indigo-600 w-8 h-8 rounded-lg flex items-center justify-center"><i class="fa-solid fa-users"></i></span>
                            ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ({{ employees.length }})
                        </h2>
                        <button @click="addEmployee" class="bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-lg hover:bg-indigo-100 text-xs font-bold transition">
                            <i class="fa-solid fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°
                        </button>
                    </div>
                    
                    <div class="space-y-2 max-h-[300px] overflow-y-auto pr-1">
                        <div v-for="(emp, index) in employees" :key="index" class="flex items-center gap-2 group p-2 rounded hover:bg-slate-50 border border-transparent hover:border-slate-100 transition">
                            <span class="text-slate-400 w-5 text-xs font-mono">{{ index + 1 }}.</span>
                            <div class="flex-1">
                                <input type="text" v-model="emp.name" 
                                    class="w-full bg-transparent border-b border-slate-200 focus:border-indigo-500 focus:outline-none text-sm pb-1" 
                                    placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô">
                                <div class="text-[10px] text-slate-400 mt-0.5 flex justify-between">
                                    <span>‡∏á‡∏≤‡∏ô‡∏™‡∏∞‡∏™‡∏°: <b>{{ (emp.accumulatedWeight || 0).toLocaleString() }}</b></span>
                                    <button @click="resetIndividualHistory(index)" class="text-xs text-red-300 hover:text-red-500" title="‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
                                </div>
                            </div>
                            <button @click="removeEmployee(index)" class="text-slate-300 hover:text-red-500 w-6 h-6 flex items-center justify-center rounded hover:bg-red-50 transition">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 card">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-bold text-slate-700 flex items-center gap-2">
                            <span class="bg-orange-100 text-orange-600 w-8 h-8 rounded-lg flex items-center justify-center"><i class="fa-solid fa-box-open"></i></span>
                            ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà ({{ taskSets.length }})
                        </h2>
                        <div class="space-x-1">
                            <button @click="clearTaskInputs" class="text-xs text-slate-400 hover:text-red-500 px-2">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button>
                            <button @click="addTaskSet" class="bg-orange-50 text-orange-600 px-3 py-1.5 rounded-lg hover:bg-orange-100 text-xs font-bold transition">
                                <i class="fa-solid fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∏‡∏î
                            </button>
                        </div>
                    </div>
                    
                    <div class="space-y-3 max-h-[400px] overflow-y-auto pr-1">
                        <div v-for="(set, setIndex) in taskSets" :key="set.id" 
                             class="border rounded-lg p-3 bg-white relative transition-all focus-within:ring-2 focus-within:ring-orange-100"
                             :class="setIndex === 0 ? 'border-orange-200' : 'border-slate-200'">
                            
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-bold text-slate-600 text-xs flex items-center gap-2">
                                    <span class="w-2 h-2 rounded-full" :class="getDotColor(setIndex)"></span>
                                    ‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà {{ setIndex + 1 }} 
                                </span>
                                <button @click="removeTaskSet(setIndex)" class="text-slate-300 hover:text-red-500"><i class="fa-solid fa-trash-can text-xs"></i></button>
                            </div>
                            
                            <textarea v-model="set.rawInput" 
                                class="w-full h-16 bg-slate-50 border border-slate-200 rounded-md p-2 text-sm focus:outline-none focus:bg-white focus:border-orange-500 font-mono resize-none text-slate-600" 
                                placeholder="‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡πÄ‡∏ä‡πà‡∏ô: 50 20 10..."></textarea>
                                
                            <div class="text-right text-[10px] text-slate-400 mt-1">
                                ‡∏û‡∏ö {{ (set.rawInput.match(/-?\d+(\.\d+)?/g) || []).length }} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                            </div>
                        </div>
                    </div>
                </div>

                <button @click="calculateDistribution" 
                    class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-indigo-200 transition transform hover:-translate-y-0.5 active:translate-y-0 flex items-center justify-center gap-2 text-lg">
                    <i class="fa-solid fa-calculator"></i> ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢
                </button>

            </div>

            <div class="lg:col-span-8">
                
                <div v-if="distributedResults.length > 0" class="animate-fade-in-up flex flex-col h-full">
                    
                    <div class="bg-indigo-900 text-white p-4 rounded-t-xl shadow-md flex flex-wrap justify-between items-center gap-4">
                        <div>
                            <h2 class="text-lg font-bold flex items-center gap-2">
                                <i class="fa-solid fa-chart-pie"></i> ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì (Preview)
                            </h2>
                            <p class="text-indigo-200 text-xs">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</p>
                        </div>
                        <div class="flex gap-2">
                            <button @click="commitResults" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-md transition flex items-center gap-2 btn-press">
                                <i class="fa-solid fa-check-circle"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏•‡πá‡∏≠‡∏Å‡∏á‡∏≤‡∏ô
                            </button>
                        </div>
                    </div>

                    <div class="bg-white border-x border-slate-200 p-2 flex justify-end gap-2 text-xs">
                        <button @click="copyText" class="px-3 py-1 bg-slate-100 hover:bg-slate-200 rounded text-slate-600 transition"><i class="fa-regular fa-copy"></i> Copy</button>
                        <button @click="exportToExcel" class="px-3 py-1 bg-green-50 hover:bg-green-100 rounded text-green-700 transition"><i class="fa-regular fa-file-excel"></i> Excel</button>
                        <button @click="exportToImage" class="px-3 py-1 bg-purple-50 hover:bg-purple-100 rounded text-purple-700 transition"><i class="fa-regular fa-image"></i> Image</button>
                    </div>

                    <div id="export-area" class="bg-white p-6 rounded-b-xl shadow-lg border border-slate-200 flex-1">
                        
                        <div class="flex flex-wrap gap-4 justify-center mb-8 bg-slate-50 p-4 rounded-xl border border-slate-100">
                            <div class="text-center px-4 border-r border-slate-200 last:border-0">
                                <div class="text-xs text-slate-500 uppercase tracking-wider font-semibold">‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏™‡∏∞‡∏™‡∏°</div>
                                <div class="text-xl font-bold text-slate-400">{{ totalHistoryWeight.toLocaleString() }}</div>
                            </div>
                            <div class="text-center px-4 border-r border-slate-200 last:border-0">
                                <div class="text-xs text-indigo-500 uppercase tracking-wider font-semibold">‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°</div>
                                <div class="text-xl font-bold text-indigo-600">+{{ totalNewWeight.toLocaleString() }}</div>
                            </div>
                            <div class="text-center px-4">
                                <div class="text-xs text-green-600 uppercase tracking-wider font-semibold">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                                <div class="text-xl font-bold text-green-700">{{ (totalHistoryWeight + totalNewWeight).toLocaleString() }}</div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div v-for="(result, idx) in distributedResults" :key="idx" 
                                 class="border rounded-xl overflow-hidden flex flex-col bg-white hover:shadow-md transition group">
                                
                                <div class="p-3 bg-slate-50 border-b flex justify-between items-center">
                                    <div class="flex items-center gap-3">
                                        <div class="bg-indigo-600 text-white w-7 h-7 rounded-full flex items-center justify-center text-xs font-bold shadow-sm">{{ idx + 1 }}</div>
                                        <div>
                                            <h3 class="font-bold text-slate-700 text-sm leading-tight">{{ result.name }}</h3>
                                            <p class="text-[10px] text-slate-500">
                                                ‡πÄ‡∏î‡∏¥‡∏°: {{ result.startWeight.toLocaleString() }} 
                                                <span class="text-indigo-600 font-bold ml-1">+{{ result.addedWeight.toLocaleString() }}</span>
                                            </p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-[10px] text-slate-400 uppercase">‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</div>
                                        <div class="font-bold text-lg text-slate-800 leading-none">{{ result.finalWeight.toLocaleString() }}</div>
                                    </div>
                                </div>
                                
                                <div class="p-3 flex-1 flex flex-wrap content-start gap-1.5 min-h-[80px]">
                                    
                                    <div v-if="result.newTasks.length === 0" class="w-full text-center text-slate-300 py-4 text-xs italic">
                                        ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô
                                    </div>

                                    <div v-for="(task, tIndex) in result.newTasks" :key="tIndex" 
                                         class="px-2 py-1 rounded text-xs border font-mono font-bold shadow-sm animate-fade-in-up"
                                         :style="{ animationDelay: `${tIndex * 50}ms` }"
                                         :class="getBadgeColor(task.originalSetIndex)">
                                        {{ task.value }}
                                    </div>
                                </div>

                                <div class="bg-slate-50 px-3 py-1.5 text-[10px] text-slate-400 border-t flex justify-between">
                                    <span>‡πÄ‡∏û‡∏¥‡πà‡∏°: {{ result.newTasks.length }} ‡∏ä‡∏¥‡πâ‡∏ô</span>
                                    <span>Diff: {{ (result.finalWeight - averageWeight).toFixed(1) }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-else class="h-full flex flex-col items-center justify-center text-slate-400 border-2 border-dashed border-slate-300 rounded-xl bg-slate-50/50 min-h-[500px]">
                    <div class="w-24 h-24 bg-white rounded-full flex items-center justify-center mb-6 shadow-sm border border-slate-100">
                        <i class="fa-solid fa-hourglass-start text-4xl text-slate-300"></i>
                    </div>
                    <h3 class="text-xl font-bold text-slate-600 mb-2">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</h3>
                    <p class="text-sm max-w-xs text-center mb-6">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ä‡∏∏‡∏î‡∏á‡∏≤‡∏ô‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡∏°‡∏∑‡∏≠ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏á‡∏≤‡∏ô‡πÇ‡∏î‡∏¢‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏î‡∏¥‡∏°</p>
                    
                    <div class="flex gap-4 text-xs text-slate-500">
                        <span class="flex items-center gap-1"><i class="fa-solid fa-save text-green-500"></i> Auto Save</span>
                        <span class="flex items-center gap-1"><i class="fa-solid fa-lock text-orange-500"></i> Lock Results</span>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    // --- Data Models ---
                    employees: [
                        { name: "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô 1", accumulatedWeight: 0, historyCount: 0 },
                        { name: "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô 2", accumulatedWeight: 0, historyCount: 0 },
                        { name: "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô 3", accumulatedWeight: 0, historyCount: 0 },
                        { name: "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô 4", accumulatedWeight: 0, historyCount: 0 },
                    ],
                    taskSets: [
                        { id: 1, rawInput: "", tasks: [] }
                    ],
                    
                    // --- Results State ---
                    distributedResults: [],
                    
                    // --- UI Config ---
                    colors: [
                        { bg: 'bg-red-100', text: 'text-red-800', border: 'border-red-200', dot: 'bg-red-500' },
                        { bg: 'bg-orange-100', text: 'text-orange-800', border: 'border-orange-200', dot: 'bg-orange-500' },
                        { bg: 'bg-emerald-100', text: 'text-emerald-800', border: 'border-emerald-200', dot: 'bg-emerald-500' },
                        { bg: 'bg-blue-100', text: 'text-blue-800', border: 'border-blue-200', dot: 'bg-blue-500' },
                        { bg: 'bg-purple-100', text: 'text-purple-800', border: 'border-purple-200', dot: 'bg-purple-500' },
                        { bg: 'bg-pink-100', text: 'text-pink-800', border: 'border-pink-200', dot: 'bg-pink-500' },
                        { bg: 'bg-cyan-100', text: 'text-cyan-800', border: 'border-cyan-200', dot: 'bg-cyan-500' },
                    ]
                }
            },
            
            // --- Auto Save Logic ---
            watch: {
                employees: {
                    handler(val) { localStorage.setItem('jd_pro_employees', JSON.stringify(val)); },
                    deep: true
                },
                taskSets: {
                    handler(val) { localStorage.setItem('jd_pro_taskSets', JSON.stringify(val)); },
                    deep: true
                }
            },
            
            mounted() {
                // Load data on startup
                const savedEmp = localStorage.getItem('jd_pro_employees');
                const savedSets = localStorage.getItem('jd_pro_taskSets');
                
                if (savedEmp) this.employees = JSON.parse(savedEmp);
                if (savedSets) this.taskSets = JSON.parse(savedSets);
            },

            computed: {
                totalHistoryWeight() {
                    return this.distributedResults.reduce((sum, r) => sum + r.startWeight, 0);
                },
                totalNewWeight() {
                    return this.distributedResults.reduce((sum, r) => sum + r.addedWeight, 0);
                },
                averageWeight() {
                    if (this.employees.length === 0) return 0;
                    return (this.totalHistoryWeight + this.totalNewWeight) / this.employees.length;
                }
            },

            methods: {
                // --- Management ---
                addEmployee() {
                    this.employees.push({ name: `‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ${this.employees.length + 1}`, accumulatedWeight: 0, historyCount: 0 });
                },
                removeEmployee(index) {
                    if (confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô? ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢')) {
                        this.employees.splice(index, 1);
                    }
                },
                resetIndividualHistory(index) {
                    if(confirm(`‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏™‡∏∞‡∏™‡∏°‡∏Ç‡∏≠‡∏á "${this.employees[index].name}" ‡πÄ‡∏õ‡πá‡∏ô 0?`)) {
                        this.employees[index].accumulatedWeight = 0;
                        this.employees[index].historyCount = 0;
                    }
                },
                resetAllData() {
                    if(confirm('‚ö†Ô∏è ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏´‡∏°‡∏î?')) {
                        localStorage.removeItem('jd_pro_employees');
                        localStorage.removeItem('jd_pro_taskSets');
                        location.reload(); // Reload for clean slate
                    }
                },
                
                addTaskSet() {
                    this.taskSets.push({ id: Date.now(), rawInput: "", tasks: [] });
                },
                removeTaskSet(index) {
                    this.taskSets.splice(index, 1);
                },
                clearTaskInputs() {
                    if(confirm('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) {
                        this.taskSets = [{ id: Date.now(), rawInput: "", tasks: [] }];
                        this.distributedResults = [];
                    }
                },

                // --- Styles ---
                getStyle(index) { return this.colors[index % this.colors.length]; },
                getBadgeColor(index) { 
                    const style = this.getStyle(index);
                    return `${style.bg} ${style.text} ${style.border}`;
                },
                getDotColor(index) { return this.getStyle(index).dot; },

                // --- Core Logic ---
                parseInput(raw) {
                    const numbers = raw.match(/-?\d+(\.\d+)?/g);
                    return numbers ? numbers.map(Number) : [];
                },

                calculateDistribution() {
                    if (this.employees.length === 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô");

                    // 1. Prepare Buckets (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏™‡∏∞‡∏™‡∏°‡πÄ‡∏î‡∏¥‡∏°)
                    // ‡πÄ‡∏£‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á Simulation Buckets ‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤ ‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞ Commit
                    let buckets = this.employees.map(e => ({
                        originalRef: e, // ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏Å‡∏•‡∏±‡∏ö object ‡∏à‡∏£‡∏¥‡∏á
                        name: e.name,
                        startWeight: e.accumulatedWeight || 0, // ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
                        currentWeight: e.accumulatedWeight || 0, // ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
                        newTasks: [], // ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö
                        addedWeight: 0
                    }));

                    // 2. Collect all new tasks
                    let allNewTasks = [];
                    this.taskSets.forEach((set, setIndex) => {
                        const tasks = this.parseInput(set.rawInput);
                        tasks.forEach(val => {
                            allNewTasks.push({ value: val, originalSetIndex: setIndex });
                        });
                    });

                    if (allNewTasks.length === 0) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏á‡∏≤‡∏ô");

                    // 3. Sort tasks descending (Greedy approach)
                    allNewTasks.sort((a, b) => b.value - a.value);

                    // 4. Distribute
                    allNewTasks.forEach(task => {
                        // ‡∏´‡∏≤‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà currentWeight ‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
                        buckets.sort((a, b) => a.currentWeight - b.currentWeight);
                        
                        const target = buckets[0];
                        target.newTasks.push(task);
                        target.currentWeight += task.value;
                        target.addedWeight += task.value;
                    });

                    // 5. Sort tasks back by set index (for display beauty)
                    buckets.forEach(b => {
                        b.newTasks.sort((a, b) => a.originalSetIndex - b.originalSetIndex || b.value - a.value);
                        b.finalWeight = parseFloat(b.currentWeight.toFixed(2));
                    });

                    // Sort employees for display (optional: sort by name or load)
                    // let's keep original index to prevent confusion
                    // But we map results to index of employees
                    
                    // Re-order results to match original employee order for consistency
                    this.distributedResults = this.employees.map(emp => {
                        return buckets.find(b => b.name === emp.name);
                    });
                },

                commitResults() {
                    if(!confirm('‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏ä‡∏∏‡∏î‡∏ô‡∏µ‡πâ?\n\n- ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏ß‡∏Å‡∏£‡∏ß‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô\n- ‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï\n- ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ä‡∏∏‡∏î‡∏ï‡πà‡∏≠‡πÑ‡∏õ')) return;

                    // Update History (Real Commit)
                    this.distributedResults.forEach((res, index) => {
                        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô employee list
                        const emp = this.employees[index];
                        emp.accumulatedWeight = res.finalWeight; 
                        emp.historyCount = (emp.historyCount || 0) + res.newTasks.length;
                    });

                    // Clear Inputs
                    this.taskSets = [{ id: Date.now(), rawInput: "", tasks: [] }];
                    this.distributedResults = [];

                    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ä‡∏∏‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ");
                },

                // --- Exports ---
                copyText() {
                    let text = `‡∏™‡∏£‡∏∏‡∏õ‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (${new Date().toLocaleTimeString()})\n`;
                    this.distributedResults.forEach(res => {
                        if(res.newTasks.length > 0) {
                            text += `üë§ ${res.name} (‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏° ${res.newTasks.length} ‡∏ä‡∏¥‡πâ‡∏ô)\n`;
                            text += `   [${res.newTasks.map(t => t.value).join(', ')}]\n`;
                        }
                    });
                    navigator.clipboard.writeText(text).then(() => alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß"));
                },
                exportToExcel() {
                    let data = [];
                    this.distributedResults.forEach(res => {
                        if(res.newTasks.length > 0) {
                            let row = {
                                "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô": res.name,
                                "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏î‡∏¥‡∏°": res.startWeight,
                                "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà": res.addedWeight,
                                "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏™‡∏∏‡∏ó‡∏ò‡∏¥": res.finalWeight,
                                "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏¥‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà": res.newTasks.length,
                                "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô": res.newTasks.map(t => t.value).join(', ')
                            };
                            data.push(row);
                        }
                    });
                    if(data.length === 0) return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ Export');
                    
                    const ws = XLSX.utils.json_to_sheet(data);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Job_Distribution");
                    XLSX.writeFile(wb, `Job_Lock_${new Date().toISOString().slice(0,10)}.xlsx`);
                },
                exportToImage() {
                    const el = document.getElementById('export-area');
                    html2canvas(el).then(canvas => {
                        const link = document.createElement('a');
                        link.download = 'summary.png';
                        link.href = canvas.toDataURL();
                        link.click();
                    });
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
