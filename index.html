<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ Ultimate (Job Distributor)</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; }
        .card { transition: all 0.3s ease; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Animation */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .list-move { transition: transform 0.4s ease; }
    </style>
</head>
<body class="p-4 md:p-8 text-slate-800">

    <div id="app" class="max-w-7xl mx-auto">
        
        <div class="text-center mb-8 relative">
            <h1 class="text-4xl font-bold text-indigo-700 mb-2 drop-shadow-sm">
                <i class="fa-solid fa-scale-balanced mr-2"></i>‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏á‡∏≤‡∏ô Ultimate
            </h1>
            <p class="text-gray-500 text-lg">Weighted Load Balancing with Capacity Control</p>
            
            <transition name="fade">
                <div v-if="toast.show" :class="`fixed top-5 right-5 z-50 px-4 py-3 rounded-lg shadow-lg text-white font-medium flex items-center gap-2 ${toast.type === 'error' ? 'bg-red-500' : 'bg-emerald-600'}`">
                    <i :class="toast.type === 'error' ? 'fa-solid fa-circle-exclamation' : 'fa-solid fa-circle-check'"></i>
                    {{ toast.message }}
                </div>
            </transition>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <div class="lg:col-span-5 space-y-6">
                
                <div class="bg-white p-5 rounded-xl shadow-sm border border-indigo-100 card relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1 h-full bg-indigo-500"></div>
                    <div class="flex justify-between items-center mb-4 pl-2">
                        <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                            <i class="fa-solid fa-users text-indigo-500"></i> ‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô ({{ employees.length }})
                        </h2>
                        <div class="space-x-2">
                            <button @click="resetEmployees" class="text-xs text-gray-400 hover:text-red-500 underline">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
                            <button @click="addEmployee" class="bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-lg hover:bg-indigo-100 text-sm font-semibold transition shadow-sm">
                                <i class="fa-solid fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ô
                            </button>
                        </div>
                    </div>

                    <div class="flex text-xs text-gray-400 mb-2 px-2 font-medium">
                        <div class="w-8 text-center">#</div>
                        <div class="flex-1">‡∏ä‡∏∑‡πà‡∏≠</div>
                        <div class="w-24 text-center" title="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô (100% = ‡∏õ‡∏Å‡∏ï‡∏¥)">Capacity %</div>
                        <div class="w-6"></div>
                    </div>

                    <div class="space-y-2 max-h-[300px] overflow-y-auto pr-1 custom-scrollbar">
                        <transition-group name="list">
                            <div v-for="(emp, index) in employees" :key="index" class="flex items-center gap-2 group bg-gray-50/50 p-1.5 rounded border border-transparent hover:border-indigo-100 hover:bg-white transition">
                                <span class="text-gray-400 w-8 text-center text-sm font-mono">{{ index + 1 }}</span>
                                <input type="text" v-model="emp.name" 
                                    class="flex-1 bg-transparent border-b border-gray-200 focus:border-indigo-500 focus:outline-none text-sm py-1 transition" 
                                    placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô">
                                
                                <div class="w-24 flex items-center justify-center relative group/tooltip">
                                    <input type="number" v-model.number="emp.capacity" min="10" max="200" step="10"
                                        class="w-14 text-center bg-white border border-gray-200 rounded text-xs py-1 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-200 outline-none"
                                        :class="emp.capacity > 100 ? 'text-green-600 font-bold' : (emp.capacity < 100 ? 'text-orange-500' : 'text-gray-600')">
                                    <span class="text-xs text-gray-400 ml-1">%</span>
                                </div>

                                <button @click="removeEmployee(index)" class="text-gray-300 hover:text-red-500 w-6 h-6 flex items-center justify-center transition">
                                    <i class="fa-solid fa-xmark"></i>
                                </button>
                            </div>
                        </transition-group>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-sm border border-orange-100 card relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1 h-full bg-orange-500"></div>
                    <div class="flex justify-between items-center mb-4 pl-2">
                        <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                            <i class="fa-solid fa-boxes-stacked text-orange-500"></i> ‡∏ä‡∏∏‡∏î‡∏á‡∏≤‡∏ô ({{ taskSets.length }})
                        </h2>
                        <div class="space-x-2">
                            <button @click="resetTaskSets" class="text-xs text-gray-400 hover:text-red-500 underline">‡∏•‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô</button>
                            <button @click="addTaskSet" class="bg-orange-50 text-orange-600 px-3 py-1.5 rounded-lg hover:bg-orange-100 text-sm font-semibold transition shadow-sm">
                                <i class="fa-solid fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∏‡∏î
                            </button>
                        </div>
                    </div>
                    
                    <div class="space-y-4 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar">
                        <transition-group name="list">
                            <div v-for="(set, setIndex) in taskSets" :key="set.id" 
                                 class="border rounded-lg p-4 bg-white relative transition-all duration-300"
                                 :class="setIndex === 0 ? 'border-l-4 border-l-red-400 border-y-gray-200 border-r-gray-200 shadow-sm' : 'border-gray-200 hover:border-orange-200'">
                                
                                <div class="flex justify-between items-center mb-2">
                                    <span class="font-bold text-gray-700 text-sm flex items-center gap-2">
                                        <span class="w-3 h-3 rounded-full shadow-sm" :class="getDotColor(setIndex)"></span>
                                        ‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà {{ setIndex + 1 }} 
                                        <span v-if="setIndex === 0" class="text-[10px] bg-red-100 text-red-600 px-2 py-0.5 rounded-full uppercase font-bold tracking-wider">High Priority</span>
                                    </span>
                                    <button @click="removeTaskSet(setIndex)" class="text-gray-400 hover:text-red-600 text-xs transition">
                                        <i class="fa-regular fa-trash-can"></i> ‡∏•‡∏ö
                                    </button>
                                </div>
                                
                                <div class="mb-2">
                                    <textarea v-model="set.rawInput" 
                                        class="w-full h-20 border border-gray-300 rounded-lg p-2 text-sm focus:outline-none focus:border-orange-500 focus:ring-1 focus:ring-orange-200 font-mono resize-none transition" 
                                        placeholder="‡∏ß‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏á‡∏≤‡∏ô ‡πÄ‡∏ä‡πà‡∏ô: 55 20 14..."></textarea>
                                </div>
                                <div class="flex justify-between text-xs text-gray-500 bg-gray-50 p-1.5 rounded">
                                    <span><i class="fa-solid fa-list-ol mr-1"></i> {{ countNumbers(set.rawInput) }} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                                    <span>‡∏£‡∏ß‡∏°: {{ sumNumbers(set.rawInput).toLocaleString() }}</span>
                                </div>
                            </div>
                        </transition-group>
                    </div>
                </div>

                <button @click="calculateDistribution" 
                    class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-4 rounded-xl shadow-lg transition transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center gap-2 text-lg">
                    <i class="fa-solid fa-rocket animate-pulse"></i> ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                </button>

            </div>

            <div class="lg:col-span-7">
                
                <div v-if="distributedResults.length > 0" class="animate-fade-in-up">
                    
                    <div class="flex flex-wrap gap-2 mb-4 justify-end bg-white p-2 rounded-lg shadow-sm">
                        <div class="flex items-center mr-auto pl-2 text-sm text-gray-500">
                           <i class="fa-solid fa-chart-pie mr-2 text-indigo-500"></i> ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                        </div>
                        <button @click="exportToExcel" class="btn-tool bg-green-50 text-green-700 hover:bg-green-100 border border-green-200">
                            <i class="fa-regular fa-file-excel"></i> Excel
                        </button>
                        <button @click="exportToImage" class="btn-tool bg-purple-50 text-purple-700 hover:bg-purple-100 border border-purple-200">
                            <i class="fa-regular fa-image"></i> Image
                        </button>
                        <button @click="exportToPDF" class="btn-tool bg-red-50 text-red-700 hover:bg-red-100 border border-red-200">
                            <i class="fa-regular fa-file-pdf"></i> PDF
                        </button>
                        <button @click="copyText" class="btn-tool bg-gray-50 text-gray-700 hover:bg-gray-100 border border-gray-200">
                            <i class="fa-regular fa-copy"></i> Copy
                        </button>
                    </div>

                    <div id="export-area" class="bg-white p-8 rounded-xl shadow-lg border border-gray-100 min-h-[600px]">
                        
                        <div class="text-center mb-8 border-b border-gray-200 pb-6">
                            <h2 class="text-2xl font-bold text-gray-800">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h2>
                            <p class="text-gray-500 text-xs mt-1">
                                <i class="fa-regular fa-clock"></i> {{ new Date().toLocaleString('th-TH') }}
                            </p>
                            
                            <div class="grid grid-cols-3 gap-4 mt-6 max-w-lg mx-auto">
                                <div class="bg-blue-50 p-3 rounded-lg text-center border border-blue-100">
                                    <div class="text-[10px] text-blue-500 font-bold uppercase tracking-wide">‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                                    <div class="text-xl font-bold text-blue-700">{{ grandTotalItems }} <span class="text-sm font-normal text-blue-400">‡∏ä‡∏¥‡πâ‡∏ô</span></div>
                                </div>
                                <div class="bg-green-50 p-3 rounded-lg text-center border border-green-100">
                                    <div class="text-[10px] text-green-500 font-bold uppercase tracking-wide">Weight ‡∏£‡∏ß‡∏°</div>
                                    <div class="text-xl font-bold text-green-700">{{ grandTotalWeight.toLocaleString() }}</div>
                                </div>
                                <div class="bg-indigo-50 p-3 rounded-lg text-center border border-indigo-100">
                                    <div class="text-[10px] text-indigo-500 font-bold uppercase tracking-wide">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (Base)</div>
                                    <div class="text-xl font-bold text-indigo-700">~{{ (grandTotalWeight / totalCapacityPoints * 100).toFixed(1) }}</div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div v-for="(result, idx) in distributedResults" :key="idx" 
                                 class="border rounded-lg overflow-hidden flex flex-col h-full bg-white shadow-sm hover:shadow-md transition group">
                                
                                <div class="p-3 border-b bg-gray-50 flex justify-between items-start relative overflow-hidden">
                                    <div class="absolute bottom-0 left-0 h-1 bg-indigo-500 transition-all duration-1000" 
                                         :style="{ width: getLoadPercentage(result.totalWeight, result.capacity) + '%' }"></div>

                                    <div class="flex items-center gap-3 z-10">
                                        <div class="bg-white border border-gray-200 text-gray-600 w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold shadow-sm">
                                            {{ idx + 1 }}
                                        </div>
                                        <div>
                                            <h3 class="font-bold text-gray-800 leading-tight">{{ result.employeeName }}</h3>
                                            <div class="text-[10px] text-gray-500 flex gap-2">
                                                <span title="Capacity"><i class="fa-solid fa-gauge-high"></i> {{ result.capacity }}%</span>
                                                <span v-if="result.tasks.length > 0">|</span>
                                                <span v-if="result.tasks.length > 0" :class="getLoadColorClass(getLoadPercentage(result.totalWeight, result.capacity))">
                                                    Load: {{ getLoadPercentage(result.totalWeight, result.capacity) }}%
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-right z-10">
                                        <div class="text-[10px] text-gray-400">Total Weight</div>
                                        <div class="font-bold text-xl text-indigo-700 leading-none">{{ result.totalWeight.toLocaleString() }}</div>
                                    </div>
                                </div>
                                
                                <div class="p-3 bg-white flex-1 min-h-[100px]">
                                    <div v-if="result.tasks.length === 0" class="h-full flex flex-col items-center justify-center text-gray-300 text-sm">
                                        <i class="fa-solid fa-mug-hot text-2xl mb-2 opacity-50"></i>
                                        <span>‡∏ß‡πà‡∏≤‡∏á‡∏á‡∏≤‡∏ô</span>
                                    </div>
                                    <div v-else class="flex flex-wrap gap-1.5 content-start">
                                        <div v-for="(task, tIndex) in result.tasks" :key="tIndex" 
                                             class="px-2 py-1 rounded text-xs border flex items-center gap-1 shadow-sm hover:scale-105 transition cursor-default bg-white"
                                             :class="getBadgeColor(task.originalSetIndex)">
                                            <span class="font-bold font-mono">{{ task.value }}</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-gray-50 px-3 py-2 text-[10px] text-gray-400 border-t flex justify-between items-center">
                                    <span><i class="fa-solid fa-cubes"></i> {{ result.tasks.length }} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-else class="h-full flex flex-col items-center justify-center text-gray-400 border-2 border-dashed border-gray-300 rounded-xl bg-gray-50/50 min-h-[500px] animate-pulse">
                    <div class="w-24 h-24 bg-gray-200 rounded-full flex items-center justify-center mb-6 text-5xl shadow-inner">
                        <i class="fa-solid fa-calculator text-gray-400"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-500 mb-2">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏á‡∏≤‡∏ô</h3>
                    <p class="text-sm max-w-xs text-center text-gray-400">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ä‡∏∏‡∏î‡∏á‡∏≤‡∏ô‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡∏°‡∏∑‡∏≠ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
                </div>

            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    // Initialize with 3 people, Capacity 100% default
                    employees: [
                        { name: '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô 1', capacity: 100 },
                        { name: '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô 2', capacity: 100 },
                        { name: '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô 3', capacity: 100 }
                    ],
                    taskSets: [
                        { id: 1, rawInput: "55 20 14 16 12 8 90", tasks: [] }
                    ],
                    distributedResults: [],
                    
                    // UX/UI States
                    toast: { show: false, message: '', type: 'success' },
                    
                    // Design System
                    colors: [
                        { bg: 'bg-red-50', text: 'text-red-700', border: 'border-red-200', dot: 'bg-red-500' },
                        { bg: 'bg-orange-50', text: 'text-orange-700', border: 'border-orange-200', dot: 'bg-orange-500' },
                        { bg: 'bg-blue-50', text: 'text-blue-700', border: 'border-blue-200', dot: 'bg-blue-500' },
                        { bg: 'bg-emerald-50', text: 'text-emerald-700', border: 'border-emerald-200', dot: 'bg-emerald-500' },
                        { bg: 'bg-purple-50', text: 'text-purple-700', border: 'border-purple-200', dot: 'bg-purple-500' },
                        { bg: 'bg-pink-50', text: 'text-pink-700', border: 'border-pink-200', dot: 'bg-pink-500' },
                        { bg: 'bg-cyan-50', text: 'text-cyan-700', border: 'border-cyan-200', dot: 'bg-cyan-500' },
                        { bg: 'bg-yellow-50', text: 'text-yellow-700', border: 'border-yellow-200', dot: 'bg-yellow-500' },
                    ]
                }
            },
            mounted() {
                this.loadFromStorage();
            },
            watch: {
                employees: {
                    handler() { this.saveToStorage(); },
                    deep: true
                },
                taskSets: {
                    handler() { this.saveToStorage(); },
                    deep: true
                }
            },
            computed: {
                grandTotalWeight() {
                    return this.distributedResults.reduce((sum, res) => sum + res.totalWeight, 0);
                },
                grandTotalItems() {
                    return this.distributedResults.reduce((sum, res) => sum + res.tasks.length, 0);
                },
                totalCapacityPoints() {
                    // Sum of all capacities to calculate weighted average
                    return this.distributedResults.reduce((sum, res) => sum + res.capacity, 0);
                }
            },
            methods: {
                // --- Storage System ---
                saveToStorage() {
                    localStorage.setItem('jd_employees', JSON.stringify(this.employees));
                    localStorage.setItem('jd_taskSets', JSON.stringify(this.taskSets));
                },
                loadFromStorage() {
                    const emp = localStorage.getItem('jd_employees');
                    const tsk = localStorage.getItem('jd_taskSets');
                    if (emp) this.employees = JSON.parse(emp);
                    if (tsk) this.taskSets = JSON.parse(tsk);
                },

                // --- Helper Logic ---
                parseInput(raw) {
                    const numbers = raw.match(/-?\d+(\.\d+)?/g);
                    return numbers ? numbers.map(n => parseFloat(n)) : [];
                },
                countNumbers(raw) {
                    return (raw.match(/-?\d+(\.\d+)?/g) || []).length;
                },
                sumNumbers(raw) {
                    const nums = this.parseInput(raw);
                    return nums.reduce((a, b) => a + b, 0);
                },
                showToast(msg, type = 'success') {
                    this.toast = { show: true, message: msg, type };
                    setTimeout(() => this.toast.show = false, 3000);
                },

                // --- Management ---
                addEmployee() {
                    this.employees.push({ name: `‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ${this.employees.length + 1}`, capacity: 100 });
                },
                removeEmployee(index) {
                    if (this.employees.length <= 1) return this.showToast('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏ô', 'error');
                    this.employees.splice(index, 1);
                },
                resetEmployees() {
                    if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) {
                        this.employees = [{ name: '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô 1', capacity: 100 }];
                        this.showToast('‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                    }
                },
                addTaskSet() {
                    this.taskSets.push({ id: Date.now(), rawInput: "", tasks: [] });
                    // Scroll to bottom logic could be added here
                },
                removeTaskSet(index) {
                    this.taskSets.splice(index, 1);
                },
                resetTaskSets() {
                    if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏ä‡∏∏‡∏î‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) {
                        this.taskSets = [{ id: Date.now(), rawInput: "", tasks: [] }];
                        this.showToast('‡∏•‡πâ‡∏≤‡∏á‡∏ä‡∏∏‡∏î‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                    }
                },

                // --- Styles ---
                getStyle(index) { return this.colors[index % this.colors.length]; },
                getBadgeColor(index) {
                    const s = this.getStyle(index);
                    return `${s.bg} ${s.text} ${s.border}`;
                },
                getDotColor(index) { return this.getStyle(index).dot; },
                
                getLoadPercentage(currentWeight, capacity) {
                    // Logic: Average Load per 1% Capacity = TotalWeight / TotalCapacityPoints
                    if (this.grandTotalWeight === 0 || this.totalCapacityPoints === 0) return 0;
                    
                    const avgLoadPerPoint = this.grandTotalWeight / this.totalCapacityPoints;
                    const expectedLoad = avgLoadPerPoint * capacity;
                    
                    // Show percentage relative to expected load (100% = perfectly balanced for this capacity)
                    // But for simple visual, let's use global max scale? No, relative is better.
                    // Actually, let's make it simpler: % of Total Work relative to Capacity share.
                    
                    // Calculation: (MyWeight / MyCapacity) / (TotalWeight / TotalCapacity) * 100
                    // If result is 100%, it means I'm carrying exactly my fair share.
                    const myShare = currentWeight / capacity;
                    const globalShare = this.grandTotalWeight / this.totalCapacityPoints;
                    
                    if (globalShare === 0) return 0;
                    return Math.round((myShare / globalShare) * 100);
                },
                getLoadColorClass(percent) {
                    if (percent > 120) return 'text-red-600 font-bold';
                    if (percent < 80) return 'text-blue-500';
                    return 'text-green-600';
                },

                // --- CORE ALGORITHM (Weighted + Capacity) ---
                calculateDistribution() {
                    const activeEmployees = this.employees.filter(e => e.name.trim() !== "");
                    
                    if (activeEmployees.length === 0) {
                        return this.showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏ô", 'error');
                    }

                    // 1. Prepare Buckets with Capacity
                    let buckets = activeEmployees.map(e => ({
                        employeeName: e.name,
                        capacity: e.capacity || 100, // Default 100 if null
                        tasks: [],
                        totalWeight: 0
                    }));

                    let hasWork = false;

                    // 2. Flatten and Process All Tasks
                    // Strategy: LPT (Longest Processing Time) is generally best for minimization
                    this.taskSets.forEach((set, setIndex) => {
                        const tasks = this.parseInput(set.rawInput);
                        if (tasks.length > 0) hasWork = true;
                        
                        // Sort Descending for Greedy Algorithm
                        tasks.sort((a, b) => b - a);

                        tasks.forEach(taskValue => {
                            // Find bucket with lowest Load Ratio
                            // Load Ratio = CurrentWeight / Capacity
                            // By minimizing this ratio, we balance work relative to capacity
                            
                            let bestBucketIndex = 0;
                            let minLoadRatio = buckets[0].totalWeight / buckets[0].capacity;

                            for (let i = 1; i < buckets.length; i++) {
                                const ratio = buckets[i].totalWeight / buckets[i].capacity;
                                if (ratio < minLoadRatio) {
                                    minLoadRatio = ratio;
                                    bestBucketIndex = i;
                                }
                            }

                            // Assign
                            buckets[bestBucketIndex].tasks.push({
                                value: taskValue,
                                originalSetIndex: setIndex
                            });
                            buckets[bestBucketIndex].totalWeight += taskValue;
                        });
                    });

                    if (!hasWork) return this.showToast("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏ô‡∏ä‡∏∏‡∏î‡∏á‡∏≤‡∏ô", 'error');

                    // 3. Post-process (Sort tasks inside buckets for display)
                    buckets.forEach(bucket => {
                        // Fix javascript floating point weirdness
                        bucket.totalWeight = Math.round(bucket.totalWeight * 100) / 100;
                        
                        // Optional: Sort tasks by Set ID then Value
                        bucket.tasks.sort((a, b) => {
                            if (a.originalSetIndex !== b.originalSetIndex) return a.originalSetIndex - b.originalSetIndex;
                            return b.value - a.value;
                        });
                    });

                    this.distributedResults = buckets;
                    this.showToast(`‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡πÅ‡∏ö‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ ${activeEmployees.length} ‡∏Ñ‡∏ô`);
                    
                    // Auto scroll to results on mobile
                    setTimeout(() => {
                        document.getElementById('export-area')?.scrollIntoView({ behavior: 'smooth' });
                    }, 100);
                },

                // --- Exports ---
                copyText() {
                    let text = `‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡πà‡∏á‡∏á‡∏≤‡∏ô (${new Date().toLocaleDateString()})\n`;
                    text += `--------------------------------\n`;
                    this.distributedResults.forEach(res => {
                        text += `üë§ ${res.employeeName} (Cap: ${res.capacity}%)\n`;
                        text += `   ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏°: ${res.totalWeight}\n`;
                        text += `   ‡∏á‡∏≤‡∏ô: ${res.tasks.map(t => t.value).join(", ")}\n\n`;
                    });
                    navigator.clipboard.writeText(text).then(() => this.showToast("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏á Clipboard ‡πÅ‡∏•‡πâ‡∏ß"));
                },
                exportToExcel() {
                    let data = [];
                    let maxTasks = 0;
                    this.distributedResults.forEach(res => {
                        if (res.tasks.length > maxTasks) maxTasks = res.tasks.length;
                        let row = {
                            "‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô": res.employeeName,
                            "Capacity(%)": res.capacity,
                            "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏°": res.totalWeight,
                            "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏¥‡πâ‡∏ô": res.tasks.length
                        };
                        res.tasks.forEach((t, i) => {
                            row[`‡∏á‡∏≤‡∏ô_${i+1}`] = t.value;
                            row[`‡∏ä‡∏∏‡∏î_${i+1}`] = t.originalSetIndex + 1;
                        });
                        data.push(row);
                    });
                    const ws = XLSX.utils.json_to_sheet(data);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Work_Distribution");
                    XLSX.writeFile(wb, `Distribution_${new Date().toISOString().slice(0,10)}.xlsx`);
                    this.showToast("‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Excel ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                },
                exportToImage() {
                    const element = document.getElementById('export-area');
                    // Hide toolbar specifically for screenshot if needed, but here we capture a clean div
                    html2canvas(element, { scale: 2 }).then(canvas => {
                        const link = document.createElement('a');
                        link.download = 'summary.png';
                        link.href = canvas.toDataURL();
                        link.click();
                        this.showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                    });
                },
                exportToPDF() {
                    const element = document.getElementById('export-area');
                    const opt = {
                        margin: 0.2,
                        filename: 'work_distribution.pdf',
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2, useCORS: true },
                        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
                    };
                    html2pdf().set(opt).from(element).save();
                    this.showToast("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á PDF...");
                }
            }
        }).mount('#app');
    </script>

    <style>
        .btn-tool {
            @apply px-3 py-1.5 rounded-lg text-xs font-semibold transition flex items-center gap-1 shadow-sm;
        }
    </style>
</body>
</html>
